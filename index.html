<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grupo ZASA - Sistema Financiero</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #334155; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Estilos de Tabla Compacta */
        .group-header { background-color: #ffffff; border-bottom: 1px solid #e2e8f0; transition: all 0.2s; }
        .group-header:hover { background-color: #f1f5f9; cursor: pointer; }
        .group-expanded { background-color: #f8fafc; border-left: 4px solid #1e293b; }
        .detail-row { background-color: #f8fafc; font-size: 0.85rem; border-left: 4px solid #1e293b; }
        
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <header class="bg-white border-b border-gray-200 h-16 flex items-center justify-between px-6 shadow-sm z-20 flex-none">
        <div class="flex items-center gap-6">
            <div class="flex items-center gap-3">
                <img src="logo-zasa.png" alt="Grupo ZASA Logo" class="w-10 h-10 rounded-lg shadow-sm object-contain bg-white border border-gray-100">
                
                <div>
                    <h1 class="text-slate-800 font-black tracking-tight text-lg leading-none">Grupo ZASA</h1>
                    <span class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Sistema Financiero</span>
                </div>
            </div>

            <div class="h-6 w-px bg-gray-200"></div>

            <div class="flex items-center gap-2 text-xs">
                <span class="text-slate-400 font-semibold uppercase">Reporte Activo:</span>
                <span id="header-week" class="bg-slate-100 text-slate-700 px-2 py-1 rounded border border-slate-200 font-bold uppercase">--</span>
            </div>
        </div>
        
        <div class="flex gap-3">
            <button onclick="location.reload()" class="text-xs font-bold text-slate-600 hover:text-slate-900 flex items-center gap-2 bg-white hover:bg-gray-50 px-4 py-2 rounded-lg border border-gray-200 transition shadow-sm">
                <span>üìÅ</span> Cargar Otro Archivo
            </button>
            <button id="btn-back" onclick="showScreen('screen-group')" class="hidden text-xs font-bold text-slate-600 hover:text-slate-900 flex items-center gap-2 bg-white hover:bg-gray-50 px-4 py-2 rounded-lg border border-gray-200 transition shadow-sm">
                <span>üè¢</span> Cambiar Unidad
            </button>
        </div>
    </header>

    <div id="screen-loading" class="absolute inset-0 z-50 bg-gray-100/95 backdrop-blur-sm flex flex-col items-center justify-center p-6">
        <div class="max-w-md w-full bg-white p-8 rounded-2xl shadow-2xl border border-gray-200">
            
            <div class="text-center mb-8">
                <img src="logo-zasa.png" alt="Grupo ZASA Logo" class="w-20 h-20 mx-auto mb-4 object-contain">
                <h2 class="text-2xl font-black text-slate-800 leading-none mb-1">Grupo ZASA</h2>
                <p class="text-sm font-bold text-slate-500 uppercase tracking-widest">Acceso a Reportes</p>
            </div>

            <div class="bg-gray-50 p-4 rounded-xl border border-gray-200 mb-6">
                <p class="text-xs font-bold text-slate-400 uppercase mb-3 text-center">Seleccione Periodo Fiscal</p>
                <div class="flex gap-3 mb-4">
                    <div class="w-1/3">
                        <select id="sel-year" class="w-full bg-white border-2 border-gray-200 rounded-lg text-sm font-bold p-2.5 outline-none focus:border-slate-500 transition"><option value="2026">2026</option></select>
                    </div>
                    <div class="w-2/3">
                        <select id="sel-week" class="w-full bg-white border-2 border-gray-200 rounded-lg text-sm font-bold p-2.5 outline-none focus:border-slate-500 transition"></select>
                    </div>
                </div>

                <button onclick="loadFromCloud()" class="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-3 rounded-lg shadow-lg transition transform active:scale-95 text-sm flex justify-center items-center gap-2">
                    Consultar en la Nube
                </button>
            </div>
            
            <div class="text-center">
                <label class="cursor-pointer text-xs text-slate-500 hover:text-slate-800 font-bold transition flex items-center justify-center gap-1 group">
                    <span>üìÇ</span> o cargar archivo local (.xlsx)
                    <input type="file" id="file-input" class="hidden" accept=".xlsx, .xls">
                </label>
            </div>
            <p id="status-msg" class="text-center text-[10px] text-red-500 mt-4 font-bold h-3"></p>
        </div>
    </div>

    <div id="screen-group" class="hidden flex-1 bg-gray-50 flex items-center justify-center p-4">
        <div class="w-full max-w-4xl">
            <h2 class="text-center text-xl font-black text-slate-800 mb-2">Unidades de Negocio</h2>
            <p class="text-center text-sm text-slate-500 mb-10 font-medium">Seleccione el √°rea operativa a consultar</p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 px-8">
                <div onclick="selectGroup('villas')" class="bg-white p-8 rounded-2xl shadow-sm border border-gray-200 cursor-pointer hover:border-slate-800 hover:shadow-xl transition-all group relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-2 h-full bg-blue-600"></div>
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-slate-800 group-hover:text-blue-800 transition">Grupo Villas</h3>
                        <span class="bg-blue-100 text-blue-800 text-[10px] font-black px-3 py-1 rounded-full uppercase tracking-wide">Maquinaria y Transporte</span>
                    </div>
                    <p class="text-sm font-medium text-slate-500">Gesti√≥n de flota, mantenimiento de equipo pesado y log√≠stica operativa.</p>
                </div>
                
                <div onclick="selectGroup('pina')" class="bg-white p-8 rounded-2xl shadow-sm border border-gray-200 cursor-pointer hover:border-slate-800 hover:shadow-xl transition-all group relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-2 h-full bg-yellow-500"></div>
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-slate-800 group-hover:text-yellow-800 transition">Grupo Pi√±a</h3>
                        <span class="bg-yellow-100 text-yellow-800 text-[10px] font-black px-3 py-1 rounded-full uppercase tracking-wide">Agroindustria</span>
                    </div>
                    <p class="text-sm font-medium text-slate-500">Costos de producci√≥n agr√≠cola, planillas de campo y exportaci√≥n.</p>
                </div>
            </div>
        </div>
    </div>

    <div id="screen-dashboard" class="hidden flex-1 flex flex-col overflow-hidden bg-white relative">
        
        <div class="bg-gray-50 border-b border-gray-200 px-8 py-4 flex justify-between items-center flex-none">
            <div class="flex items-center gap-3">
                <h2 id="dash-title" class="text-lg font-black text-slate-800 uppercase tracking-tight">--</h2>
            </div>
            <div class="flex gap-8 text-xs">
                <div class="flex flex-col items-end">
                    <span class="text-slate-400 font-bold uppercase tracking-wider text-[10px]">Total Egresos ‚Ç°</span>
                    <span id="head-total-crc" class="font-bold text-slate-800 font-mono text-base">‚Ç°0</span>
                </div>
                <div class="flex flex-col items-end">
                    <span class="text-slate-400 font-bold uppercase tracking-wider text-[10px]">Total Egresos $</span>
                    <span id="head-total-usd" class="font-bold text-slate-800 font-mono text-base">$0.00</span>
                </div>
            </div>
        </div>

        <div class="flex-1 overflow-auto p-8 max-w-7xl mx-auto w-full space-y-8">
            
            <div>
                <h3 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-4 pl-1">Posici√≥n de Tesorer√≠a</h3>
                <div class="grid grid-cols-2 gap-6">
                    <div class="bg-white rounded-xl border border-gray-200 p-5 flex items-center justify-between shadow-sm relative overflow-hidden">
                        <div class="absolute bottom-0 left-0 w-full h-1 bg-emerald-500"></div>
                        <div>
                            <p class="text-[11px] font-bold text-gray-400 uppercase tracking-wider mb-1">Disponibilidad Colones</p>
                            <p id="bank-crc" class="text-3xl font-bold text-slate-800 font-mono tracking-tight">‚Ç°0</p>
                        </div>
                        <div class="bg-emerald-50 text-emerald-600 h-12 w-12 rounded-xl flex items-center justify-center text-2xl font-bold">‚Ç°</div>
                    </div>
                    <div class="bg-white rounded-xl border border-gray-200 p-5 flex items-center justify-between shadow-sm relative overflow-hidden">
                        <div class="absolute bottom-0 left-0 w-full h-1 bg-blue-500"></div>
                        <div>
                            <p class="text-[11px] font-bold text-gray-400 uppercase tracking-wider mb-1">Disponibilidad D√≥lares</p>
                            <p id="bank-usd" class="text-3xl font-bold text-slate-800 font-mono tracking-tight">$0.00</p>
                        </div>
                        <div class="bg-blue-50 text-blue-600 h-12 w-12 rounded-xl flex items-center justify-center text-2xl font-bold">$</div>
                    </div>
                </div>
            </div>

            <div>
                 <h3 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-4 pl-1">Detalle de Ejecuci√≥n Presupuestaria</h3>
                 <div class="border border-gray-200 rounded-xl overflow-hidden shadow-sm">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-100 text-slate-500 text-[11px] uppercase font-bold tracking-wider">
                            <tr>
                                <th class="px-6 py-3 text-left w-10"></th>
                                <th class="px-6 py-3 text-left w-1/2">Categor√≠a / Concepto</th>
                                <th class="px-6 py-3 text-right">Monto (‚Ç°)</th>
                                <th class="px-6 py-3 text-right">Monto ($)</th>
                            </tr>
                        </thead>
                        <tbody id="table-body" class="text-slate-700 font-medium"></tbody>
                        <tfoot class="bg-gray-50 border-t-2 border-gray-200 font-bold text-slate-800 text-sm">
                            <tr>
                                <td colspan="2" class="px-6 py-4 text-right uppercase tracking-wide text-xs">Totales del Periodo:</td>
                                <td id="foot-total-crc" class="px-6 py-4 text-right font-mono">‚Ç°0</td>
                                <td id="foot-total-usd" class="px-6 py-4 text-right font-mono">$0.00</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
            
            <div class="text-center py-4 border-t border-gray-100">
                <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Grupo ZASA ‚Ä¢ Reporte Confidencial</p>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURACI√ìN DE LISTAS ORDENADAS
        const ORDER_PINA = ["Mano Obra Finca","Mano Obra Terceros (Contratista)","Planillas y Cargas Sociales","Servicios Gerencia","Vacaciones y Liquidaci√≥n","Ret. CCSS Empleado","CCSS","Caja Chica","Aguinaldos","Liquidaciones de personal","Maquila","Pagos Municipales","Servicios P√∫blicos","Canon Pozos","Pensi√≥n","Transporte de Fruta ¬¢","Transporte de Fruta $ (Villas)","Insumos Agr√≠colas $","Combustible","Alquiler","Taller Materiales e Insumos","Costos de Cart√≥n - Etiquetas","Gastos Indirectos ¬¢","Gastos Indirectos $","Proveedores Cr√©dito ¬¢","Proveedores Cr√©dito $","Viabilidades Ambientales","Operaci√≥n ¬¢","Operaci√≥n $","INS","Compra Fruta","Banco Pichincha","Gastos Indirectos Julesyor","Tramites de Exportaciones $","Tramites de Exportaciones ¬¢","Trasportes Alquilados $"];
        const ORDER_VILLAS = ["Mano de Obra","Servicios P√∫blicos","Mantenimiento","Proveedores","Caja Chica","Impuestos","Seguridad","Jardiner√≠a","Alquileres"];

        let dataVillas=[], dataPina=[], currentData=[], currentOrder=[], loadedWeek="--";

        // INICIALIZAR
        window.onload = () => {
            const selWeek = document.getElementById('sel-week');
            for(let i=1; i<=53; i++) {
                const opt = document.createElement('option');
                const val = i.toString().padStart(2, '0');
                opt.value = val; opt.innerText = `Semana ${val}`;
                if(val==="06") opt.selected = true;
                selWeek.appendChild(opt);
            }
        };

        // CARGA NUBE
        async function loadFromCloud() {
            const y = document.getElementById('sel-year').value;
            const w = document.getElementById('sel-week').value;
            const btn = document.querySelector('#screen-loading button');
            const msg = document.getElementById('status-msg');
            
            const name = `Semana_${y}_${w}.xlsx`;
            
            btn.innerHTML = `<span class="animate-pulse">Conectando al servidor...</span>`; btn.disabled=true; msg.innerText="";

            try {
                let res = await fetch(`./excels/${name}?t=`+Date.now());
                if(!res.ok) res = await fetch(`./${name}?t=`+Date.now());
                if(!res.ok) throw new Error();
                
                const buf = await res.arrayBuffer();
                processWorkbook(buf, `SEM ${w} - ${y}`);
            } catch(e) {
                msg.innerText = `Error de conexi√≥n: No se encontr√≥ el reporte "${name}"`;
            } finally {
                btn.innerHTML = "Consultar en la Nube"; btn.disabled=false;
            }
        }

        // CARGA LOCAL
        document.getElementById('file-input').addEventListener('change', (e) => {
            const f = e.target.files[0]; if(!f) return;
            const r = new FileReader();
            r.onload = (ev) => processWorkbook(new Uint8Array(ev.target.result), f.name);
            r.readAsArrayBuffer(f);
        });

        // PROCESAR EXCEL
        function processWorkbook(data, label) {
            try {
                const wb = XLSX.read(data, {type:'array'});
                if(wb.SheetNames.length<2) { alert("Estructura inv√°lida: Se requieren hojas 'Villas' y 'Pina'"); return; }
                
                dataVillas = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                dataPina = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[1]]);
                
                loadedWeek = label;
                document.getElementById('header-week').innerText = label;
                
                document.getElementById('screen-loading').classList.add('hidden');
                document.getElementById('screen-group').classList.remove('hidden');
            } catch(e) { alert("El archivo est√° da√±ado o tiene un formato incorrecto."); }
        }

        // NAVEGACI√ìN
        function showScreen(id) {
            ['screen-group','screen-dashboard'].forEach(s => document.getElementById(s).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            document.getElementById(id).classList.add('fade-in');
            
            const btnBack = document.getElementById('btn-back');
            if(id === 'screen-dashboard') btnBack.classList.remove('hidden');
            else btnBack.classList.add('hidden');
        }

        // SELECCI√ìN GRUPO
        function selectGroup(g) {
            if(g==='villas') { currentData=dataVillas; currentOrder=ORDER_VILLAS; document.getElementById('dash-title').innerText="GRUPO VILLAS"; }
            else { currentData=dataPina; currentOrder=ORDER_PINA; document.getElementById('dash-title').innerText="GRUPO PI√ëA"; }
            renderDashboard();
            showScreen('screen-dashboard');
        }

        // RENDERIZADO
        function renderDashboard() {
            const groups={}; 
            let expCRC=0, expUSD=0, bkCRC=0, bkUSD=0;
            const fmt = (n, cur) => new Intl.NumberFormat(cur==='CRC'?'es-CR':'en-US', {style:'currency', currency:cur}).format(n);

            currentData.forEach(r => {
                const cat = (r.Categoria||r.Concepto||"Varios").trim();
                const clean = (v) => typeof v==='number' ? v : parseFloat((v||"0").toString().replace(/[^0-9.-]+/g,""))||0;
                const crc = clean(r.Colones), usd = clean(r.Dolares);
                
                if(cat.toUpperCase().includes('BANCOS') || cat.toUpperCase().includes('SALDO')) {
                    bkCRC+=crc; bkUSD+=usd; return;
                }

                if(!groups[cat]) groups[cat] = {c:0, u:0, items:[]};
                groups[cat].c += crc; groups[cat].u += usd;
                expCRC += crc; expUSD += usd;
                if(crc>0||usd>0) groups[cat].items.push({d:r.Concepto, f:r.Fecha, c:crc, u:usd});
            });

            // Actualizar KPIs
            document.getElementById('bank-crc').innerText = fmt(bkCRC, 'CRC');
            document.getElementById('bank-usd').innerText = fmt(bkUSD, 'USD');
            
            const tC = fmt(expCRC, 'CRC'), tU = fmt(expUSD, 'USD');
            ['head-total-crc','foot-total-crc'].forEach(i => document.getElementById(i).innerText=tC);
            ['head-total-usd','foot-total-usd'].forEach(i => document.getElementById(i).innerText=tU);

            // Ordenar
            let keys = Object.keys(groups).sort((a,b) => {
                const iA = currentOrder.indexOf(a), iB = currentOrder.indexOf(b);
                if(iA!==-1 && iB!==-1) return iA-iB; if(iA!==-1) return -1; if(iB!==-1) return 1; return a.localeCompare(b);
            });

            const tbody = document.getElementById('table-body'); tbody.innerHTML='';
            
            keys.forEach((k, idx) => {
                const g = groups[k]; if(g.c===0 && g.u===0) return;
                const rid = `row-${idx}`;
                
                // Header Fila
                const tr = document.createElement('tr');
                tr.className = 'group-header';
                tr.onclick = () => toggle(rid, tr);
                
                const sC = g.c>0 ? 'text-slate-800 font-bold' : 'text-gray-300 font-light';
                const sU = g.u>0 ? 'text-slate-800 font-bold' : 'text-gray-300 font-light';

                tr.innerHTML = `
                    <td class="px-6 py-4 text-center"><span id="icon-${rid}" class="text-[10px] text-gray-400 transition-transform duration-200 block">‚ñ∂</span></td>
                    <td class="px-6 py-4 font-bold text-slate-700">${k}</td>
                    <td class="px-6 py-4 text-right font-mono ${sC}">${g.c>0?fmt(g.c,'CRC'):'-'}</td>
                    <td class="px-6 py-4 text-right font-mono ${sU}">${g.u>0?fmt(g.u,'USD'):'-'}</td>
                `;
                tbody.appendChild(tr);

                // Filas Hijos
                g.items.forEach(it => {
                    const sub = document.createElement('tr');
                    sub.className = `hidden detail-row ${rid}`;
                    
                    let date = it.f;
                    if(typeof date==='number') date = new Date((date-(25567+2))*86400000).toLocaleDateString('es-CR');
                    else if(typeof date==='string' && date.includes('T')) date = date.split('T')[0];

                    sub.innerHTML = `
                        <td></td>
                        <td class="px-6 py-3 pl-8 flex items-center gap-3">
                            ${date ? `<span class="bg-white border border-gray-200 px-1.5 py-0.5 rounded text-[10px] text-gray-500 font-mono font-bold">${date}</span>` : ''}
                            <span class="truncate text-slate-600 font-medium">${it.d||'Detalle'}</span>
                        </td>
                        <td class="px-6 py-3 text-right font-mono text-xs text-slate-600">${it.c>0?fmt(it.c,'CRC'):'-'}</td>
                        <td class="px-6 py-3 text-right font-mono text-xs text-slate-600">${it.u>0?fmt(it.u,'USD'):'-'}</td>
                    `;
                    tbody.appendChild(sub);
                });
            });
            
            if(!tbody.innerHTML) tbody.innerHTML='<tr><td colspan="4" class="p-12 text-center text-gray-400 text-sm font-bold uppercase tracking-wider">No hay registros de egresos en este periodo.</td></tr>';
        }

        function toggle(id, el) {
            const rows = document.querySelectorAll(`.${id}`);
            const icon = document.getElementById(`icon-${id}`);
            const isExpanded = el.classList.contains('group-expanded');
            
            if(isExpanded) {
                el.classList.remove('group-expanded');
                icon.style.transform = 'rotate(0deg)';
                rows.forEach(r => r.classList.add('hidden'));
            } else {
                el.classList.add('group-expanded');
                icon.style.transform = 'rotate(90deg)';
                rows.forEach(r => r.classList.remove('hidden'));
            }
        }
    </script>
</body>
</html>
