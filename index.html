<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte Ejecutivo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #334155; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Estilos de Tabla Compacta */
        .group-header { 
            background-color: #ffffff; 
            border-bottom: 1px solid #e2e8f0; 
            transition: all 0.2s;
        }
        .group-header:hover { background-color: #f1f5f9; cursor: pointer; }
        
        /* Cuando est√° expandido */
        .group-expanded { 
            background-color: #f8fafc; 
            border-left: 4px solid #3b82f6; /* L√≠nea Azul indicadora */
        }
        
        /* Filas de detalle */
        .detail-row { 
            background-color: #f8fafc; 
            font-size: 0.85rem;
            border-left: 4px solid #3b82f6; /* Continuaci√≥n de la l√≠nea azul */
        }
        
        /* Scroll fino */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <header class="bg-white border-b border-gray-200 h-14 flex items-center justify-between px-6 shadow-sm z-20 flex-none">
        <div class="flex items-center gap-4">
            <div class="flex items-center gap-2 text-slate-800 font-bold tracking-tight">
                <span class="bg-slate-800 text-white w-6 h-6 flex items-center justify-center rounded text-xs">F</span>
                <span>FINANZAS CORPORATIVAS</span>
            </div>
            <div class="h-4 w-px bg-gray-300 mx-2"></div>
            <div class="flex items-center gap-2 text-xs">
                <span class="text-slate-400 font-semibold uppercase">PERIODO:</span>
                <span id="header-week" class="bg-blue-50 text-blue-700 px-2 py-0.5 rounded font-bold uppercase">--</span>
            </div>
        </div>
        
        <div class="flex gap-3">
            <button onclick="location.reload()" class="text-xs font-medium text-slate-500 hover:text-slate-800 flex items-center gap-1 bg-gray-50 hover:bg-gray-100 px-3 py-1.5 rounded border border-gray-200 transition">
                <span>üìÇ</span> Cambiar Archivo
            </button>
            <button id="btn-back" onclick="showScreen('screen-group')" class="hidden text-xs font-medium text-slate-500 hover:text-slate-800 flex items-center gap-1 bg-gray-50 hover:bg-gray-100 px-3 py-1.5 rounded border border-gray-200 transition">
                <span>üè¢</span> Cambiar Empresa
            </button>
        </div>
    </header>

    <div id="screen-loading" class="absolute inset-0 z-50 bg-gray-50 flex flex-col items-center justify-center p-6">
        <div class="max-w-md w-full bg-white p-8 rounded-xl shadow-lg border border-gray-200">
            <h2 class="text-lg font-bold text-slate-800 mb-1">Cargar Reporte</h2>
            <p class="text-xs text-slate-500 mb-6">Selecciona el a√±o y semana para consultar.</p>

            <div class="flex gap-3 mb-4">
                <div class="w-1/3">
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">A√±o</label>
                    <select id="sel-year" class="w-full bg-slate-50 border border-slate-300 rounded text-sm font-semibold p-2 outline-none focus:border-blue-500"><option value="2026">2026</option></select>
                </div>
                <div class="w-2/3">
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Semana</label>
                    <select id="sel-week" class="w-full bg-slate-50 border border-slate-300 rounded text-sm font-semibold p-2 outline-none focus:border-blue-500"></select>
                </div>
            </div>

            <button onclick="loadFromCloud()" class="w-full bg-slate-900 hover:bg-slate-800 text-white font-bold py-2.5 rounded shadow transition text-sm flex justify-center items-center gap-2 mb-4">
                Consultar Reporte
            </button>
            
            <div class="border-t border-gray-100 pt-4 text-center">
                <label class="cursor-pointer text-xs text-blue-600 hover:underline font-medium">
                    o cargar archivo local (.xlsx)
                    <input type="file" id="file-input" class="hidden" accept=".xlsx, .xls">
                </label>
            </div>
            <p id="status-msg" class="text-center text-[10px] text-red-500 mt-2 h-3"></p>
        </div>
    </div>

    <div id="screen-group" class="hidden flex-1 bg-gray-50 flex items-center justify-center p-4">
        <div class="w-full max-w-4xl">
            <h2 class="text-center text-xl font-bold text-slate-800 mb-8">Seleccionar Unidad de Negocio</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 px-8">
                <div onclick="selectGroup('villas')" class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 cursor-pointer hover:border-blue-500 hover:shadow-md transition group">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-lg font-bold text-slate-700 group-hover:text-blue-600">Grupo Villas</h3>
                        <span class="bg-blue-50 text-blue-600 text-[10px] font-bold px-2 py-0.5 rounded uppercase">Inmobiliaria</span>
                    </div>
                    <p class="text-xs text-slate-400">Ver reporte de gastos operativos y administrativos.</p>
                </div>
                <div onclick="selectGroup('pina')" class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 cursor-pointer hover:border-yellow-500 hover:shadow-md transition group">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-lg font-bold text-slate-700 group-hover:text-yellow-600">Grupo Pi√±a</h3>
                        <span class="bg-yellow-50 text-yellow-600 text-[10px] font-bold px-2 py-0.5 rounded uppercase">Agroindustria</span>
                    </div>
                    <p class="text-xs text-slate-400">Ver reporte de costos de producci√≥n y finca.</p>
                </div>
            </div>
        </div>
    </div>

    <div id="screen-dashboard" class="hidden flex-1 flex flex-col overflow-hidden bg-white relative">
        
        <div class="bg-gray-50 border-b border-gray-200 px-6 py-3 flex justify-between items-center flex-none">
            <h2 id="dash-title" class="text-base font-bold text-slate-800 uppercase tracking-tight">--</h2>
            <div class="flex gap-6 text-xs">
                <div>
                    <span class="text-slate-400 font-medium uppercase mr-2">Total Colones:</span>
                    <span id="head-total-crc" class="font-bold text-slate-700 font-mono">‚Ç°0</span>
                </div>
                <div>
                    <span class="text-slate-400 font-medium uppercase mr-2">Total D√≥lares:</span>
                    <span id="head-total-usd" class="font-bold text-slate-700 font-mono">$0.00</span>
                </div>
            </div>
        </div>

        <div class="flex-1 overflow-auto p-6 max-w-7xl mx-auto w-full space-y-6">
            
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-white rounded border border-gray-200 p-4 flex items-center justify-between shadow-sm">
                    <div>
                        <p class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Disponibilidad Colones</p>
                        <p id="bank-crc" class="text-xl font-bold text-emerald-700 font-mono mt-0.5">‚Ç°0</p>
                    </div>
                    <div class="text-emerald-100 text-3xl opacity-50">‚Ç°</div>
                </div>
                <div class="bg-white rounded border border-gray-200 p-4 flex items-center justify-between shadow-sm">
                    <div>
                        <p class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Disponibilidad D√≥lares</p>
                        <p id="bank-usd" class="text-xl font-bold text-blue-700 font-mono mt-0.5">$0.00</p>
                    </div>
                    <div class="text-blue-100 text-3xl opacity-50">$</div>
                </div>
            </div>

            <div class="border border-gray-200 rounded-lg overflow-hidden">
                <div class="bg-gray-100 px-4 py-2 border-b border-gray-200 flex justify-between items-center">
                    <h3 class="text-xs font-bold text-slate-600 uppercase">Detalle de Egresos</h3>
                </div>
                
                <table class="w-full text-sm">
                    <thead class="bg-gray-50 text-slate-500 text-[10px] uppercase font-semibold">
                        <tr>
                            <th class="px-4 py-2 text-left w-8"></th> <th class="px-4 py-2 text-left w-1/2">Categor√≠a / Partida</th>
                            <th class="px-4 py-2 text-right">Monto (‚Ç°)</th>
                            <th class="px-4 py-2 text-right">Monto ($)</th>
                        </tr>
                    </thead>
                    <tbody id="table-body" class="text-slate-700">
                        </tbody>
                    <tfoot class="bg-slate-50 border-t-2 border-slate-200 font-bold text-slate-800 text-xs">
                        <tr>
                            <td colspan="2" class="px-4 py-3 text-right uppercase tracking-wide">Total Egresos:</td>
                            <td id="foot-total-crc" class="px-4 py-3 text-right font-mono text-sm">‚Ç°0</td>
                            <td id="foot-total-usd" class="px-4 py-3 text-right font-mono text-sm">$0.00</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            
            <p class="text-center text-[10px] text-gray-400 mt-4">Fin del Reporte</p>
        </div>
    </div>

    <script>
        // === CONFIGURACI√ìN ===
        const ORDER_PINA = ["Mano Obra Finca","Mano Obra Terceros (Contratista)","Planillas y Cargas Sociales","Servicios Gerencia","Vacaciones y Liquidaci√≥n","Ret. CCSS Empleado","CCSS","Caja Chica","Aguinaldos","Liquidaciones de personal","Maquila","Pagos Municipales","Servicios P√∫blicos","Canon Pozos","Pensi√≥n","Transporte de Fruta ¬¢","Transporte de Fruta $ (Villas)","Insumos Agr√≠colas $","Combustible","Alquiler","Taller Materiales e Insumos","Costos de Cart√≥n - Etiquetas","Gastos Indirectos ¬¢","Gastos Indirectos $","Proveedores Cr√©dito ¬¢","Proveedores Cr√©dito $","Viabilidades Ambientales","Operaci√≥n ¬¢","Operaci√≥n $","INS","Compra Fruta","Banco Pichincha","Gastos Indirectos Julesyor","Tramites de Exportaciones $","Tramites de Exportaciones ¬¢","Trasportes Alquilados $"];
        const ORDER_VILLAS = ["Mano de Obra","Servicios P√∫blicos","Mantenimiento","Proveedores","Caja Chica","Impuestos","Seguridad","Jardiner√≠a","Alquileres"];

        let dataVillas=[], dataPina=[], currentData=[], currentOrder=[], loadedWeek="--";

        // === INICIO ===
        window.onload = () => {
            const selWeek = document.getElementById('sel-week');
            for(let i=1; i<=53; i++) {
                const opt = document.createElement('option');
                const val = i.toString().padStart(2, '0');
                opt.value = val; opt.innerText = `Semana ${val}`;
                if(val==="06") opt.selected = true;
                selWeek.appendChild(opt);
            }
        };

        // === CARGA ===
        async function loadFromCloud() {
            const y = document.getElementById('sel-year').value;
            const w = document.getElementById('sel-week').value;
            const btn = document.querySelector('#screen-loading button');
            const msg = document.getElementById('status-msg');
            
            const name = `Semana_${y}_${w}.xlsx`;
            
            btn.innerHTML = `<span class="animate-pulse">Buscando...</span>`; btn.disabled=true; msg.innerText="";

            try {
                let res = await fetch(`./excels/${name}?t=`+Date.now());
                if(!res.ok) res = await fetch(`./${name}?t=`+Date.now());
                if(!res.ok) throw new Error();
                
                const buf = await res.arrayBuffer();
                processWorkbook(buf, `SEM ${w} - ${y}`);
            } catch(e) {
                msg.innerText = `Error: No se encontr√≥ "${name}"`;
            } finally {
                btn.innerHTML = "Consultar Reporte"; btn.disabled=false;
            }
        }

        document.getElementById('file-input').addEventListener('change', (e) => {
            const f = e.target.files[0]; if(!f) return;
            const r = new FileReader();
            r.onload = (ev) => processWorkbook(new Uint8Array(ev.target.result), f.name);
            r.readAsArrayBuffer(f);
        });

        function processWorkbook(data, label) {
            try {
                const wb = XLSX.read(data, {type:'array'});
                if(wb.SheetNames.length<2) { alert("El Excel requiere hojas 'Villas' y 'Pina'"); return; }
                
                dataVillas = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                dataPina = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[1]]);
                
                loadedWeek = label;
                document.getElementById('header-week').innerText = label;
                
                document.getElementById('screen-loading').classList.add('hidden');
                document.getElementById('screen-group').classList.remove('hidden');
            } catch(e) { alert("Archivo Inv√°lido"); }
        }

        // === NAVEGACI√ìN ===
        function showScreen(id) {
            ['screen-group','screen-dashboard'].forEach(s => document.getElementById(s).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            document.getElementById(id).classList.add('fade-in');
            
            const btnBack = document.getElementById('btn-back');
            if(id === 'screen-dashboard') btnBack.classList.remove('hidden');
            else btnBack.classList.add('hidden');
        }

        function selectGroup(g) {
            if(g==='villas') { currentData=dataVillas; currentOrder=ORDER_VILLAS; document.getElementById('dash-title').innerText="GRUPO VILLAS"; }
            else { currentData=dataPina; currentOrder=ORDER_PINA; document.getElementById('dash-title').innerText="GRUPO PI√ëA"; }
            renderDashboard();
            showScreen('screen-dashboard');
        }

        // === RENDERIZADO ===
        function renderDashboard() {
            const groups={}; 
            let expCRC=0, expUSD=0, bkCRC=0, bkUSD=0;
            const fmt = (n, cur) => new Intl.NumberFormat(cur==='CRC'?'es-CR':'en-US', {style:'currency', currency:cur}).format(n);

            currentData.forEach(r => {
                const cat = (r.Categoria||r.Concepto||"Varios").trim();
                const clean = (v) => typeof v==='number' ? v : parseFloat((v||"0").toString().replace(/[^0-9.-]+/g,""))||0;
                const crc = clean(r.Colones), usd = clean(r.Dolares);
                
                if(cat.toUpperCase().includes('BANCOS') || cat.toUpperCase().includes('SALDO')) {
                    bkCRC+=crc; bkUSD+=usd; return;
                }

                if(!groups[cat]) groups[cat] = {c:0, u:0, items:[]};
                groups[cat].c += crc; groups[cat].u += usd;
                expCRC += crc; expUSD += usd;
                if(crc>0||usd>0) groups[cat].items.push({d:r.Concepto, f:r.Fecha, c:crc, u:usd});
            });

            // Actualizar KPIs
            document.getElementById('bank-crc').innerText = fmt(bkCRC, 'CRC');
            document.getElementById('bank-usd').innerText = fmt(bkUSD, 'USD');
            
            const tC = fmt(expCRC, 'CRC'), tU = fmt(expUSD, 'USD');
            ['head-total-crc','foot-total-crc'].forEach(i => document.getElementById(i).innerText=tC);
            ['head-total-usd','foot-total-usd'].forEach(i => document.getElementById(i).innerText=tU);

            // Ordenar
            let keys = Object.keys(groups).sort((a,b) => {
                const iA = currentOrder.indexOf(a), iB = currentOrder.indexOf(b);
                if(iA!==-1 && iB!==-1) return iA-iB; if(iA!==-1) return -1; if(iB!==-1) return 1; return a.localeCompare(b);
            });

            const tbody = document.getElementById('table-body'); tbody.innerHTML='';
            
            keys.forEach((k, idx) => {
                const g = groups[k]; if(g.c===0 && g.u===0) return;
                const rid = `row-${idx}`;
                
                // FILA PADRE
                const tr = document.createElement('tr');
                tr.className = 'group-header';
                tr.onclick = () => toggle(rid, tr);
                
                // Estilo condicional para n√∫meros (gris si es 0, negro si hay valor)
                const sC = g.c>0 ? 'text-slate-800 font-bold' : 'text-gray-300 font-light';
                const sU = g.u>0 ? 'text-slate-800 font-bold' : 'text-gray-300 font-light';

                tr.innerHTML = `
                    <td class="px-4 py-3 text-center"><span id="icon-${rid}" class="text-[10px] text-gray-400 transition-transform duration-200 block">‚ñ∂</span></td>
                    <td class="px-4 py-3 font-semibold text-slate-700">${k}</td>
                    <td class="px-4 py-3 text-right font-mono ${sC}">${g.c>0?fmt(g.c,'CRC'):'-'}</td>
                    <td class="px-4 py-3 text-right font-mono ${sU}">${g.u>0?fmt(g.u,'USD'):'-'}</td>
                `;
                tbody.appendChild(tr);

                // FILAS HIJAS
                g.items.forEach(it => {
                    const sub = document.createElement('tr');
                    sub.className = `hidden detail-row ${rid}`;
                    
                    let date = it.f;
                    if(typeof date==='number') date = new Date((date-(25567+2))*86400000).toLocaleDateString('es-CR');
                    else if(typeof date==='string' && date.includes('T')) date = date.split('T')[0];

                    sub.innerHTML = `
                        <td></td>
                        <td class="px-4 py-2 pl-6 flex items-center gap-3">
                            ${date ? `<span class="bg-white border border-gray-200 px-1 py-0.5 rounded text-[9px] text-gray-400 font-mono">${date}</span>` : ''}
                            <span class="truncate text-slate-500">${it.d||'Detalle'}</span>
                        </td>
                        <td class="px-4 py-2 text-right font-mono text-xs text-slate-500">${it.c>0?fmt(it.c,'CRC'):'-'}</td>
                        <td class="px-4 py-2 text-right font-mono text-xs text-slate-500">${it.u>0?fmt(it.u,'USD'):'-'}</td>
                    `;
                    tbody.appendChild(sub);
                });
            });
            
            if(!tbody.innerHTML) tbody.innerHTML='<tr><td colspan="4" class="p-8 text-center text-gray-400 text-xs">No hay datos para mostrar</td></tr>';
        }

        function toggle(id, el) {
            const rows = document.querySelectorAll(`.${id}`);
            const icon = document.getElementById(`icon-${id}`);
            const isExpanded = el.classList.contains('group-expanded');
            
            if(isExpanded) {
                el.classList.remove('group-expanded');
                icon.style.transform = 'rotate(0deg)';
                rows.forEach(r => r.classList.add('hidden'));
            } else {
                el.classList.add('group-expanded');
                icon.style.transform = 'rotate(90deg)';
                rows.forEach(r => r.classList.remove('hidden'));
            }
        }
    </script>
</body>
</html>
