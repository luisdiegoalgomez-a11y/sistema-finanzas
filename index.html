<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grupo ZASA - Tesorer√≠a Final</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* === ESTILOS GLOBALES === */
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #0f172a; font-size: 13px; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Fondo Corporativo */
        .bg-corporate {
            background-color: #0f172a;
            background-image: 
                radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
                radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
        }

        /* Tabla Compacta */
        .group-header { background-color: #e2e8f0; border-bottom: 1px solid #cbd5e1; cursor: pointer; height: 32px; transition: background 0.1s; }
        .group-header:hover { background-color: #cbd5e1; }
        .group-expanded { background-color: #1e293b !important; color: #ffffff !important; border-bottom: none; }
        .group-expanded td { color: white !important; }
        .group-expanded .icon-arrow { transform: rotate(90deg); color: white; }
        .detail-row { background-color: #ffffff; border-left: 3px solid #1e293b; border-right: 1px solid #e2e8f0; border-bottom: 1px solid #f1f5f9; height: 28px; }
        
        /* Inputs */
        .input-edit { background: transparent; border: 1px solid transparent; border-radius: 2px; padding: 0 4px; width: 85px; text-align: right; font-family: 'JetBrains Mono'; font-size: 12px; color: #0f172a; height: 24px; }
        .input-edit:hover, .input-edit:focus { background: #f8fafc; border-color: #cbd5e1; outline: none; }
        .input-changed { background: #dcfce7; border-color: #16a34a; font-weight: bold; color: #15803d; }
        
        .input-tc { 
            background: #f8fafc; border: 1px solid #cbd5e1; color: #334155; 
            font-family: 'JetBrains Mono'; font-weight: bold; text-align: center;
            border-radius: 6px; height: 32px; width: 80px; transition: all 0.2s;
        }
        .input-tc:focus { border-color: #3b82f6; background: white; outline: none; box-shadow: 0 0 0 2px rgba(59,130,246,0.2); }

        /* Scroll */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 3px; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <div id="screen-loading" class="absolute inset-0 z-50 bg-corporate flex flex-col items-center justify-center p-6 text-white">
        <div class="mb-8 text-center fade-in">
            <img src="logo-zasa.png" onerror="this.src='https://placehold.co/64x64?text=GZ'" class="w-20 h-20 mx-auto mb-4 object-contain bg-white rounded-xl p-2 shadow-2xl">
            <h1 class="text-3xl font-extrabold tracking-tight">Grupo ZASA</h1>
            <p class="text-slate-400 text-xs font-bold uppercase tracking-[0.3em] mt-1">Portal Financiero</p>
        </div>

        <div class="w-full max-w-sm bg-white/10 backdrop-blur-lg border border-white/10 rounded-2xl p-8 shadow-2xl fade-in relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500"></div>
            
            <div id="loader-overlay" class="hidden absolute inset-0 bg-slate-900/90 flex flex-col items-center justify-center z-20 backdrop-blur-sm">
                <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-400 mb-3"></div>
                <span class="text-xs font-bold text-blue-200 tracking-wider">PROCESANDO...</span>
            </div>

            <div class="space-y-5">
                <div>
                    <label class="block text-[10px] font-bold text-slate-300 uppercase mb-1 ml-1">Ejercicio Fiscal</label>
                    <div class="relative">
                        <select id="sel-year" onchange="resetWeek()" class="w-full bg-slate-800 border border-slate-600 text-white text-sm font-bold rounded-lg p-3 appearance-none focus:ring-2 focus:ring-blue-500 outline-none transition">
                            <option value="2026">2026</option>
                            <option value="2027">2027</option>
                        </select>
                        <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-slate-400">‚ñº</div>
                    </div>
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-slate-300 uppercase mb-1 ml-1">Periodo Semanal</label>
                    <div class="relative">
                        <select id="sel-week" onchange="loadFromCloud()" class="w-full bg-slate-800 border border-slate-600 text-white text-sm font-bold rounded-lg p-3 appearance-none focus:ring-2 focus:ring-blue-500 outline-none hover:bg-slate-700 cursor-pointer transition"></select>
                        <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-slate-400">‚ñº</div>
                    </div>
                </div>
            </div>
            <p id="status-msg" class="text-[10px] font-bold text-red-300 mt-4 text-center min-h-[1rem]"></p>
            <div class="mt-6 pt-4 border-t border-white/10 text-center">
                <label class="cursor-pointer text-[10px] text-slate-400 hover:text-white font-bold transition flex justify-center items-center gap-2 group">
                    <span class="group-hover:scale-110 transition-transform">üìÇ</span> Carga Manual
                    <input type="file" id="file-input" class="hidden" accept=".xlsx, .xls">
                </label>
            </div>
        </div>
    </div>

    <div id="screen-group" class="hidden absolute inset-0 z-40 bg-slate-50 flex items-center justify-center p-6">
        <div class="absolute top-0 left-0 w-full p-6 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <img src="logo-zasa.png" class="w-8 h-8 object-contain">
                <div class="h-8 w-px bg-slate-300"></div>
                <div>
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Archivo Activo</p>
                    <p id="group-file-name" class="text-sm font-black text-slate-800 leading-none">--</p>
                </div>
            </div>
            <button onclick="location.reload()" class="text-xs font-bold text-slate-500 hover:text-red-600 transition flex items-center gap-1">
                ‚úï Cerrar Sesi√≥n (Borra Cambios)
            </button>
        </div>

        <div class="w-full max-w-5xl">
            <h2 class="text-3xl font-black text-slate-800 text-center mb-2 tracking-tight">Unidades de Negocio</h2>
            <p class="text-center text-slate-500 font-medium mb-12">Los cambios se mantienen hasta cerrar sesi√≥n.</p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 px-4">
                <div onclick="selectGroup('villas')" class="group relative bg-white h-64 rounded-2xl shadow-lg border border-slate-200 cursor-pointer overflow-hidden hover:shadow-2xl hover:-translate-y-1 transition-all duration-300">
                    <div class="absolute top-0 left-0 w-full h-1 bg-blue-600"></div>
                    <div class="p-8 h-full flex flex-col justify-between relative z-10">
                        <div>
                            <span class="inline-block bg-blue-100 text-blue-700 text-[10px] font-black px-2 py-1 rounded mb-4 uppercase tracking-wider">Divisi√≥n Log√≠stica</span>
                            <h3 class="text-2xl font-black text-slate-800 group-hover:text-blue-700 transition-colors">Grupo Villas</h3>
                            <p class="text-xs font-bold text-slate-400 uppercase mt-1 tracking-widest">Maquinaria & Transporte</p>
                        </div>
                        <div class="flex items-center gap-2 text-xs font-bold text-slate-500 group-hover:text-blue-600 transition-colors"><span>Ingresar</span><span>‚Üí</span></div>
                    </div>
                </div>
                <div onclick="selectGroup('pina')" class="group relative bg-white h-64 rounded-2xl shadow-lg border border-slate-200 cursor-pointer overflow-hidden hover:shadow-2xl hover:-translate-y-1 transition-all duration-300">
                    <div class="absolute top-0 left-0 w-full h-1 bg-yellow-500"></div>
                    <div class="p-8 h-full flex flex-col justify-between relative z-10">
                        <div>
                            <span class="inline-block bg-yellow-100 text-yellow-800 text-[10px] font-black px-2 py-1 rounded mb-4 uppercase tracking-wider">Divisi√≥n Agr√≠cola</span>
                            <h3 class="text-2xl font-black text-slate-800 group-hover:text-yellow-700 transition-colors">Grupo Pi√±a</h3>
                            <p class="text-xs font-bold text-slate-400 uppercase mt-1 tracking-widest">Producci√≥n & Exportaci√≥n</p>
                        </div>
                        <div class="flex items-center gap-2 text-xs font-bold text-slate-500 group-hover:text-yellow-600 transition-colors"><span>Ingresar</span><span>‚Üí</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="screen-dashboard" class="hidden flex flex-col h-screen overflow-hidden bg-white">
        
        <div class="flex-none bg-white border-b border-gray-200 px-4 py-2 flex justify-between items-center shadow-sm z-30 h-16">
            <div class="flex items-center gap-3">
                <button onclick="showScreen('screen-group')" class="text-slate-400 hover:text-slate-800 font-bold text-[10px] uppercase tracking-wide flex items-center gap-1 bg-slate-50 px-3 py-1.5 rounded-lg border border-slate-200 transition">
                    <span>‚Üê</span> Men√∫
                </button>
                <div class="h-6 w-px bg-gray-200"></div>
                <div class="flex flex-col">
                    <span class="text-[9px] font-bold text-slate-400 uppercase tracking-wider">M√≥dulo Activo</span>
                    <h2 id="dash-title" class="text-sm font-black text-slate-800 uppercase leading-none">--</h2>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div class="flex flex-col items-end mr-2">
                    <label class="text-[9px] font-bold text-slate-400 uppercase tracking-wider mb-0.5">Tipo de Cambio ‚Ç°</label>
                    <input type="number" id="input-exchange-rate" class="input-tc" placeholder="0.00" onchange="renderDashboard()">
                </div>
                <div class="h-8 w-px bg-gray-200"></div>
                <button onclick="saveExcel()" class="hidden text-[10px] font-bold text-white bg-slate-900 hover:bg-black flex items-center gap-2 px-4 py-2 rounded-lg shadow-lg transition transform active:scale-95" id="btn-save">
                    üíæ GUARDAR CAMBIOS
                </button>
            </div>
        </div>

        <div class="flex-none bg-slate-50 border-b border-gray-200 p-4 z-20 shadow-md">
            <div class="max-w-7xl mx-auto">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden relative">
                        <div class="bg-gradient-to-r from-emerald-600 to-teal-500 px-4 py-2 flex justify-between items-center">
                            <span class="text-white font-bold text-xs tracking-wide">FLUJO EN COLONES</span>
                            <span class="text-white font-black text-xs">‚Ç°</span>
                        </div>
                        <div class="p-3 space-y-1"> <div class="flex justify-between items-center border-b border-gray-100 pb-1">
                                <span class="text-xs font-semibold text-slate-500">Saldo en Bancos</span>
                                <span id="calc-bank-crc" class="font-mono text-sm font-bold text-slate-700">‚Ç°0</span>
                            </div>
                            <div class="flex justify-between items-center border-b border-gray-100 pb-1">
                                <span class="text-xs font-semibold text-slate-500">(-) Total Gastos</span>
                                <span id="calc-exp-crc" class="font-mono text-sm font-bold text-red-500">‚Ç°0</span>
                            </div>
                            <div class="pt-1 flex justify-between items-end">
                                <span class="text-xs font-bold text-slate-800">Resultado Neto</span>
                                <span id="calc-net-crc" class="font-mono text-xl font-black text-slate-800">‚Ç°0</span>
                            </div>
                            <div id="crc-deficit-alert" class="hidden bg-red-50 border-l-2 border-red-500 p-2 mt-2 rounded-r">
                                <div class="flex items-center gap-2">
                                    <span class="text-red-500 text-base">‚ö†Ô∏è</span>
                                    <div class="flex justify-between w-full items-center">
                                        <span class="text-[10px] font-bold text-red-800 uppercase">Faltante:</span>
                                        <span id="crc-missing-amount" class="text-sm font-black text-red-700 font-mono">‚Ç°0</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden relative">
                        <div class="bg-gradient-to-r from-blue-600 to-indigo-600 px-4 py-2 flex justify-between items-center">
                            <span class="text-white font-bold text-xs tracking-wide">FLUJO EN D√ìLARES</span>
                            <span class="text-white font-black text-xs">$</span>
                        </div>
                        <div class="p-3 space-y-1"> <div class="flex justify-between items-center border-b border-gray-100 pb-1">
                                <span class="text-xs font-semibold text-slate-500">Saldo en Bancos</span>
                                <span id="calc-bank-usd" class="font-mono text-sm font-bold text-slate-700">$0.00</span>
                            </div>
                            <div class="flex justify-between items-center border-b border-gray-100 pb-1">
                                <span class="text-xs font-semibold text-slate-500">(-) Gastos Operativos</span>
                                <span id="calc-exp-usd" class="font-mono text-sm font-bold text-red-500">$0.00</span>
                            </div>
                            <div id="row-fx-cover" class="hidden flex justify-between items-center border-b border-gray-100 pb-1 bg-yellow-50 -mx-3 px-3 py-1 mt-1">
                                <div class="flex items-center gap-1">
                                    <span class="text-yellow-600">‚ö†Ô∏è</span>
                                    <span class="text-[10px] font-bold text-yellow-800 uppercase">Se requiere vender:</span>
                                </div>
                                <span id="calc-fx-usd" class="font-mono text-sm font-black text-yellow-700">$0.00</span>
                            </div>
                            <div class="pt-1 flex justify-between items-end">
                                <span class="text-xs font-bold text-slate-800">Disponibilidad Final</span>
                                <span id="calc-net-usd" class="font-mono text-xl font-black text-slate-800">$0.00</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex-1 overflow-auto p-6 bg-gray-100 custom-scroll">
            <div class="max-w-7xl mx-auto space-y-6">
                <div class="bg-white border border-gray-200 rounded-xl overflow-hidden shadow-sm">
                    <div class="bg-slate-50 px-6 py-2 border-b border-gray-200 flex justify-between items-center sticky top-0 z-10">
                        <h3 class="text-xs font-black text-slate-700 uppercase tracking-wider">Detalle de Partidas</h3>
                        <span class="text-[10px] font-bold text-slate-400">Edici√≥n habilitada</span>
                    </div>
                    <table class="w-full text-xs border-collapse">
                        <thead class="bg-white text-slate-400 text-[10px] uppercase font-bold tracking-wider border-b border-gray-100 sticky top-0">
                            <tr>
                                <th class="px-6 py-3 text-left w-10"></th>
                                <th class="px-6 py-3 text-left">Concepto</th>
                                <th class="px-4 py-3 text-right text-gray-300">Plan ‚Ç°</th>
                                <th class="px-4 py-3 text-right text-slate-800">Ejecutado ‚Ç°</th>
                                <th class="px-4 py-3 text-right text-gray-300">Plan $</th>
                                <th class="px-4 py-3 text-right text-slate-800">Ejecutado $</th>
                            </tr>
                        </thead>
                        <tbody id="table-body" class="text-slate-700"></tbody>
                    </table>
                </div>
                
                <div class="text-center py-4">
                    <p class="text-[9px] font-bold text-slate-300 uppercase tracking-widest">Sistema Financiero Grupo ZASA</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const ORDER_PINA = ["Mano Obra Finca","Mano Obra Terceros (Contratista)","Planillas y Cargas Sociales","Servicios Gerencia","Vacaciones y Liquidaci√≥n","Ret. CCSS Empleado","CCSS","Caja Chica","Aguinaldos","Liquidaciones de personal","Maquila","Pagos Municipales","Servicios P√∫blicos","Canon Pozos","Pensi√≥n","Transporte de Fruta ¬¢","Transporte de Fruta $ (Villas)","Insumos Agr√≠colas $","Combustible","Alquiler","Taller Materiales e Insumos","Costos de Cart√≥n - Etiquetas","Gastos Indirectos ¬¢","Gastos Indirectos $","Proveedores Cr√©dito ¬¢","Proveedores Cr√©dito $","Viabilidades Ambientales","Operaci√≥n ¬¢","Operaci√≥n $","INS","Compra Fruta","Banco Pichincha","Gastos Indirectos Julesyor","Tramites de Exportaciones $","Tramites de Exportaciones ¬¢","Trasportes Alquilados $"];
        const ORDER_VILLAS = ["Mano de Obra","Servicios P√∫blicos","Mantenimiento","Proveedores","Caja Chica","Impuestos","Seguridad","Jardiner√≠a","Alquileres"];

        let globalWorkbook = null;
        let activeSheetName = "";
        let globalDataVillas = null;
        let globalDataPina = null;
        let currentView = "";
        let loadedFileName = "";

        window.onload = () => {
            const s = document.getElementById('sel-week');
            s.appendChild(new Option("-- Seleccionar Semana --", "", true, true));
            for(let i=1; i<=53; i++) s.appendChild(new Option(`Semana ${i.toString().padStart(2,'0')}`, i.toString().padStart(2,'0')));
        };

        function resetWeek() { document.getElementById('sel-week').value = ""; }

        async function loadFromCloud() {
            const w = document.getElementById('sel-week').value;
            if(!w) return;
            const y = document.getElementById('sel-year').value;
            const name = `Semana_${y}_${w}.xlsx`;
            
            document.getElementById('loader-overlay').classList.remove('hidden');
            document.getElementById('status-msg').innerText = "";

            try {
                let res = await fetch(`./excels/${name}?t=${Date.now()}`);
                if(!res.ok) res = await fetch(`./${name}?t=${Date.now()}`);
                if(!res.ok) throw new Error();
                const buf = await res.arrayBuffer();
                setTimeout(() => processWorkbook(buf, name), 600);
            } catch(e) {
                document.getElementById('status-msg').innerText = "‚ö†Ô∏è Error: Archivo no encontrado en el servidor.";
                document.getElementById('sel-week').value = "";
                document.getElementById('loader-overlay').classList.add('hidden');
            }
        }

        document.getElementById('file-input').addEventListener('change', (e) => {
            const f = e.target.files[0]; if(!f) return;
            const r = new FileReader();
            r.onload = (ev) => processWorkbook(new Uint8Array(ev.target.result), f.name);
            r.readAsArrayBuffer(f);
        });

        function processWorkbook(data, name) {
            try {
                globalWorkbook = XLSX.read(data, {type:'array'});
                loadedFileName = name;
                globalDataVillas = XLSX.utils.sheet_to_json(globalWorkbook.Sheets[globalWorkbook.SheetNames[0]]);
                globalDataPina = XLSX.utils.sheet_to_json(globalWorkbook.Sheets[globalWorkbook.SheetNames[1]]);
                document.getElementById('group-file-name').innerText = name;
                document.getElementById('screen-loading').classList.add('hidden');
                document.getElementById('loader-overlay').classList.add('hidden');
                document.getElementById('screen-group').classList.remove('hidden');
                document.getElementById('btn-save').classList.remove('hidden');
            } catch(e) { alert("Archivo inv√°lido o corrupto."); }
        }

        function selectGroup(g) {
            currentView = g;
            if(g==='villas') { 
                document.getElementById('dash-title').innerText = "GRUPO VILLAS";
            } else {
                document.getElementById('dash-title').innerText = "GRUPO PI√ëA";
            }
            renderDashboard();
            showScreen('screen-dashboard');
        }

        // Funci√≥n Limpieza NaN
        function parseMoney(val) {
            if (val === undefined || val === null || val === "") return 0;
            if (typeof val === 'number') return val;
            let cleanStr = val.toString().replace(/[^0-9.-]/g, '');
            if (cleanStr === "." || cleanStr === "-") return 0;
            let num = parseFloat(cleanStr);
            return isNaN(num) ? 0 : num;
        }

        function calculateData() {
            const rawData = currentView === 'villas' ? globalDataVillas : globalDataPina;
            const groups = {};
            let totals = { crc:0, usd:0, bkCRC:0, bkUSD:0 };

            rawData.forEach((row, index) => {
                const cat = (row.Categoria||row.Concepto||"Varios").trim();
                const initCRC = parseMoney(row.Colones);
                const initUSD = parseMoney(row.Dolares);
                let execCRC = row.Colones_Ejecutados !== undefined ? parseMoney(row.Colones_Ejecutados) : initCRC;
                let execUSD = row.Dolares_Ejecutados !== undefined ? parseMoney(row.Dolares_Ejecutados) : initUSD;

                if(cat.toUpperCase().includes('BANCOS') || cat.toUpperCase().includes('SALDO')) {
                    totals.bkCRC += execCRC; totals.bkUSD += execUSD; return;
                }

                if(!groups[cat]) groups[cat] = { tC:0, tU:0, items:[] };
                groups[cat].tC += execCRC; 
                groups[cat].tU += execUSD;
                totals.crc += execCRC;
                totals.usd += execUSD;

                if(execCRC > 0 || execUSD > 0 || initCRC > 0 || initUSD > 0) {
                    groups[cat].items.push({
                        idx: index,
                        desc: row.Concepto || "Sin detalle",
                        iC: initCRC, iU: initUSD,
                        eC: execCRC, eU: execUSD,
                        isModC: row.Colones_Ejecutados !== undefined,
                        isModU: row.Dolares_Ejecutados !== undefined
                    });
                }
            });
            return { groups, totals };
        }

        function renderDashboard() {
            const { groups, totals } = calculateData();
            const fmtFull = (n,c) => new Intl.NumberFormat(c==='CRC'?'es-CR':'en-US',{style:'currency',currency:c, maximumFractionDigits:0}).format(n);
            const val = (n) => n > 0 ? n : '';

            // --- L√ìGICA DE TESORER√çA ---
            
            // 1. Colones (Real)
            const netCRC = totals.bkCRC - totals.crc;
            document.getElementById('calc-bank-crc').innerText = fmtFull(totals.bkCRC, 'CRC');
            document.getElementById('calc-exp-crc').innerText = fmtFull(totals.crc, 'CRC');
            const elNetCRC = document.getElementById('calc-net-crc');
            elNetCRC.innerText = fmtFull(netCRC, 'CRC');
            elNetCRC.className = netCRC >= 0 ? 'font-mono text-xl font-black text-emerald-600' : 'font-mono text-xl font-black text-red-600';

            // Alerta de D√©ficit
            const deficitBox = document.getElementById('crc-deficit-alert');
            const exchangeRate = parseFloat(document.getElementById('input-exchange-rate').value) || 0;
            let dollarsNeeded = 0;

            if (netCRC < 0) {
                deficitBox.classList.remove('hidden');
                document.getElementById('crc-missing-amount').innerText = fmtFull(Math.abs(netCRC), 'CRC');
                if (exchangeRate > 0) dollarsNeeded = Math.abs(netCRC) / exchangeRate;
            } else {
                deficitBox.classList.add('hidden');
            }

            // 2. D√≥lares (SIN RESTAR AUTOM√ÅTICAMENTE)
            const netUSD = totals.bkUSD - totals.usd;
            document.getElementById('calc-bank-usd').innerText = fmtFull(totals.bkUSD, 'USD');
            document.getElementById('calc-exp-usd').innerText = fmtFull(totals.usd, 'USD');
            
            const elNetUSD = document.getElementById('calc-net-usd');
            elNetUSD.innerText = fmtFull(netUSD, 'USD');
            elNetUSD.className = netUSD >= 0 ? 'font-mono text-xl font-black text-blue-600' : 'font-mono text-xl font-black text-red-600';

            // L√≠nea de Cobertura
            const rowFX = document.getElementById('row-fx-cover');
            if (dollarsNeeded > 0) {
                rowFX.classList.remove('hidden');
                document.getElementById('calc-fx-usd').innerText = new Intl.NumberFormat('en-US',{style:'currency',currency:'USD'}).format(dollarsNeeded);
            } else {
                rowFX.classList.add('hidden');
            }

            // Render Tabla
            const tbody = document.getElementById('table-body'); tbody.innerHTML = '';
            renderRows(groups, tbody, val);
        }

        function renderRows(groups, tbody, val) {
            const fmt = (n,c) => n > 0 ? new Intl.NumberFormat(c==='CRC'?'es-CR':'en-US',{style:'currency',currency:c, maximumFractionDigits:0}).format(n) : '';
            const currentOrder = currentView === 'villas' ? ORDER_VILLAS : ORDER_PINA;
            
            let keys = Object.keys(groups).sort((a,b) => {
                const iA = currentOrder.indexOf(a), iB = currentOrder.indexOf(b);
                if(iA!==-1 && iB!==-1) return iA-iB; if(iA!==-1) return -1; if(iB!==-1) return 1; return a.localeCompare(b);
            });

            keys.forEach((k, idx) => {
                const g = groups[k]; if(g.tC===0 && g.tU===0) return;
                const rid = `g-${idx}`;
                const spacer = document.createElement('tr'); spacer.className = 'h-1 bg-transparent border-none'; tbody.appendChild(spacer);

                const tr = document.createElement('tr');
                tr.className = 'group-header';
                tr.onclick = () => toggle(rid, tr);
                tr.innerHTML = `
                    <td class="px-6 text-center"><span id="icon-${rid}" class="text-[9px] text-slate-500 transition-transform duration-200 block icon-arrow">‚ñ∂</span></td>
                    <td class="px-6 font-bold uppercase tracking-wide text-[10px]">${k}</td>
                    <td class="px-4 text-right text-[10px] text-gray-400 font-mono"></td>
                    <td class="px-4 text-right font-bold font-mono text-xs">${fmt(g.tC,'CRC')}</td>
                    <td class="px-4 text-right text-[10px] text-gray-400 font-mono"></td>
                    <td class="px-4 text-right font-bold font-mono text-xs">${fmt(g.tU,'USD')}</td>
                `;
                tbody.appendChild(tr);

                g.items.forEach(it => {
                    const sub = document.createElement('tr');
                    sub.className = `hidden detail-row ${rid}`;
                    sub.innerHTML = `
                        <td></td>
                        <td class="px-6 pl-8 text-[11px] font-medium text-slate-600 truncate max-w-[200px]" title="${it.desc}">${it.desc}</td>
                        <td class="px-4 text-right text-[9px] text-gray-400 font-mono">${fmt(it.iC,'CRC')}</td>
                        <td class="px-4 text-right"><input type="number" value="${val(it.eC)}" onchange="updateValue(${it.idx}, 'Colones_Ejecutados', this.value)" class="input-edit ${it.isModC?'input-changed':''}" placeholder="${val(it.iC)}"></td>
                        <td class="px-4 text-right text-[9px] text-gray-400 font-mono">${fmt(it.iU,'USD')}</td>
                        <td class="px-4 text-right"><input type="number" value="${val(it.eU)}" onchange="updateValue(${it.idx}, 'Dolares_Ejecutados', this.value)" class="input-edit ${it.isModU?'input-changed':''}" placeholder="${val(it.iU)}"></td>
                    `;
                    tbody.appendChild(sub);
                });
            });
        }

        function updateValue(idx, field, val) {
            const targetData = currentView === 'villas' ? globalDataVillas : globalDataPina;
            if(val === "") delete targetData[idx][field];
            else targetData[idx][field] = parseFloat(val);
            renderDashboard();
        }

        function saveExcel() {
            const sheetVillas = XLSX.utils.json_to_sheet(globalDataVillas);
            const sheetPina = XLSX.utils.json_to_sheet(globalDataPina);
            globalWorkbook.Sheets[globalWorkbook.SheetNames[0]] = sheetVillas;
            globalWorkbook.Sheets[globalWorkbook.SheetNames[1]] = sheetPina;
            XLSX.writeFile(globalWorkbook, `EDITADO_${loadedFileName}`);
            alert("‚úÖ Guardado Exitoso.\nSube el archivo descargado a la carpeta 'excels' en GitHub.");
        }

        function showScreen(id) {
            ['screen-group','screen-dashboard'].forEach(s=>document.getElementById(s).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }
        function toggle(id, el) {
            const rows = document.querySelectorAll(`.${id}`);
            const isExp = el.classList.contains('group-expanded');
            if(isExp) { el.classList.remove('group-expanded'); rows.forEach(r=>r.classList.add('hidden')); }
            else { el.classList.add('group-expanded'); rows.forEach(r=>r.classList.remove('hidden')); }
        }
    </script>
</body>
</html>
